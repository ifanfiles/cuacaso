<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Radar + Prakiraan BMKG</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 100vh; width: 100%; }
    .control, .timestamp, .slider-container, .legend {
      position: absolute; z-index: 1000;
      background: white; border-radius: 6px; padding: 5px 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .control { top: 10px; left: 10px; }
    .control button { margin:2px; padding:4px 8px; border:none; border-radius:4px; cursor:pointer; background:#1976d2; color:white; }
    .control button:hover { background:#125a9c; }
    .timestamp { bottom: 50px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); color: white; font-family: monospace; }
    .slider-container { bottom: 10px; left: 50%; transform: translateX(-50%); width: 60%; text-align:center; }
    .legend { bottom: 10px; right: 10px; font-size:12px; }
    .legend div { display:flex; align-items:center; margin-bottom:2px; }
    .legend span { width:18px; height:12px; margin-right:6px; display:inline-block; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="control">
    <button id="prev">‚è™ Prev</button>
    <button id="play">‚ñ∂ Play</button>
    <button id="stop">‚èπ Stop</button>
    <button id="next">‚è© Next</button>
  </div>

  <div class="timestamp" id="timestamp">Loading...</div>

  <div class="slider-container">
    <input type="range" id="frameSlider" min="0" value="0" step="1">
  </div>

  <!-- Legend -->
  <div class="legend">
    <strong>Kategori Cuaca</strong>
    <div><span style="background:#00bfff"></span> Hujan Ringan</div>
    <div><span style="background:#0077ff"></span> Hujan Sedang</div>
    <div><span style="background:#0000ff"></span> Hujan Lebat</div>
    <div><span style="background:#888"></span> Berawan</div>
    <div><span style="background:#ffff00"></span> Cerah Berawan</div>
    <div><span style="background:#ffcc00"></span> Cerah</div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([-7.685, 109.903], 7);

    // Basemap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    let radarLayers = [];
    let frames = [];
    let currentFrame = 0;
    let playInterval;
    const slider = document.getElementById("frameSlider");
    const tsElement = document.getElementById("timestamp");

    // Warna sesuai cuaca
    function colorCuaca(c) {
      if (!c) return "#ccc";
      if (c.includes("Lebat")) return "#0000ff";
      if (c.includes("Sedang")) return "#0077ff";
      if (c.includes("Ringan")) return "#00bfff";
      if (c.includes("Berawan")) return "#888";
      if (c.includes("Cerah Berawan")) return "#ffff00";
      if (c.includes("Cerah")) return "#ffcc00";
      return "#ccc";
    }

    let prakiraanData = null;
    let geojsonLayer;

    // Load prakiraan JSON
    fetch("prakiraan_kabupaten_full3jam.json")
      .then(r => r.json())
      .then(data => { prakiraanData = data; });

    // Load RainViewer
    fetch("https://api.rainviewer.com/public/weather-maps.json")
      .then(res => res.json())
      .then(data => {
        const host = data.host;
        frames = [...data.radar.past, ...data.radar.nowcast];
        slider.max = frames.length - 1;

        frames.forEach(frame => {
          const url = `${host}${frame.path}/256/{z}/{x}/{y}/2/1_1.png`;
          const layer = L.tileLayer(url, { opacity: 0 });
          radarLayers.push(layer);
          layer.addTo(map);
        });

        showFrame(0);

        document.getElementById("play").onclick = () => {
          clearInterval(playInterval);
          playInterval = setInterval(() => {
            currentFrame = (currentFrame + 1) % frames.length;
            showFrame(currentFrame);
          }, 1000);
        };
        document.getElementById("stop").onclick = () => clearInterval(playInterval);
        document.getElementById("next").onclick = () => { currentFrame = (currentFrame + 1) % frames.length; showFrame(currentFrame); };
        document.getElementById("prev").onclick = () => { currentFrame = (currentFrame - 1 + frames.length) % frames.length; showFrame(currentFrame); };
        slider.oninput = e => { currentFrame = parseInt(e.target.value); showFrame(currentFrame); };
      });

    function formatTime(utc) {
      const date = new Date(utc * 1000);
      date.setHours(date.getUTCHours() + 7);
      return date.toLocaleString("id-ID", { day: "2-digit", month: "short", hour: "2-digit", minute: "2-digit" });
    }

    function showFrame(i) {
      radarLayers.forEach((layer, idx) => layer.setOpacity(idx === i ? 0.7 : 0));
      tsElement.innerText = formatTime(frames[i].time);

      // Update prakiraan kabupaten sesuai label waktu
      if (prakiraanData && geojsonLayer) {
        geojsonLayer.eachLayer(layer => {
          const kab = layer.feature.properties.FIRST_KA_1 || layer.feature.properties.NAME;
          const slotMap = prakiraanData[kab];
          if (slotMap) {
            // ambil label pertama yang ada
            const label = Object.keys(slotMap)[i % Object.keys(slotMap).length];
            const info = slotMap[label];
            const clr = colorCuaca(info.cuaca);
            layer.setStyle({ fillColor: clr, fillOpacity: 0.5, color: "#555", weight: 1 });
            layer.bindPopup(`<b>${kab}</b><br>${label}<br>üå¶ ${info.cuaca}<br>üå° ${info.suhu} ¬∞C<br>üíß ${info.hum} %`);
          }
        });
      }
    }

    // Load batas kabupaten
    fetch("batas_wilayah.geojson")
      .then(res => res.json())
      .then(data => {
        geojsonLayer = L.geoJSON(data, {
          style: { color: "#555", weight: 1, fillOpacity: 0.1 }
        }).addTo(map);
        map.fitBounds(geojsonLayer.getBounds());
      });
  </script>
</body>
</html>
