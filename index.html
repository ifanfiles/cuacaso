<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <title>Peta Prakiraan Hujan per Kabupaten</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    #map { height: 86vh; }
    .controls { padding:8px; background:#fff; box-shadow:0 1px 4px rgba(0,0,0,0.3); }
    .legend { background:#fff; padding:8px; line-height:1.6; }
    .legend .item { display:flex; align-items:center; gap:8px; }
    .colorbox { width:18px; height:14px; display:inline-block; border:1px solid #444; }
  </style>
</head>
<body>
  <div class="controls">
    <label>Waktu: <select id="timeSelect"></select></label>
  </div>
  <div id="map"></div>
  <div id="legend" class="legend" style="position: absolute; right: 10px; bottom: 10px; z-index:1000;"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  // --- Warna kategori cuaca ---
  const categoryColors = {
    "Cerah": "#bcd4ff",
    "Cerah Berawan": "#d6f5d6",
    "Berawan": "#e8e8e8",
    "Hujan Ringan": "#7be57b",
    "Hujan Sedang": "#ffd84d",
    "Hujan Lebat": "#ff9a2e",
    "Hujan Sangat Lebat": "#ff4d4d",
    "Ekstrem": "#b84dff"
  };

  // Nama file
  const GEOJSON_FILE = 'Batas_SO_kel.json';
  const FORECAST_FILE = 'prakiraan_kabupaten_full3jam.json';

  let map = L.map('map').setView([-7.9, 110.4], 9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OSM'
  }).addTo(map);

  let geojsonLayer;
  let forecastData = null;
  let timestamps = [];

  function normName(name){
    return (name||'').trim().toLowerCase();
  }

  // Load data
  Promise.all([
    fetch(FORECAST_FILE).then(r=>r.json()),
    fetch(GEOJSON_FILE).then(r=>r.json())
  ]).then(([forecast, geojson])=>{
    forecastData = forecast;

    // Ambil daftar waktu dari salah satu kabupaten
    const firstKey = Object.keys(forecastData)[0];
    timestamps = Object.keys(forecastData[firstKey]);
    const timeSelect = document.getElementById('timeSelect');
    timestamps.forEach(t=>{
      const opt = document.createElement('option');
      opt.value = t;
      opt.textContent = t;
      timeSelect.appendChild(opt);
    });

    // Render awal
    addGeojsonLayer(geojson, timestamps[0]);

    // Event ganti waktu
    timeSelect.addEventListener('change', (e)=>{
      updateChoropleth(e.target.value);
    });

    // Buat legenda
    drawLegend();
  }).catch(err=>{
    console.error(err);
    alert('Gagal memuat data. Pastikan file JSON & GeoJSON ada di folder yang sama.');
  });

  function styleFeature(feature, timeKey){
    const props = feature.properties || {};
    const kabupaten = props.WADMKC; // ambil nama kabupaten dari GeoJSON
    let cuaca = null, suhu = null, hum = null;

    const k = Object.keys(forecastData).find(fk => normName(fk) === normName(kabupaten));
    if(k && forecastData[k] && forecastData[k][timeKey]){
      cuaca = forecastData[k][timeKey].cuaca;
      suhu = forecastData[k][timeKey].suhu;
      hum = forecastData[k][timeKey].hum;
    }

    const color = categoryColors[cuaca] || '#cccccc';
    return {
      color: '#444',
      weight: 0.6,
      fillColor: color,
      fillOpacity: 0.8
    };
  }

  function onEachFeature(feature, layer){
    layer.on({
      click: function(e){
        const props = feature.properties || {};
        const kabupaten = props.WADMKC;
        const t = document.getElementById('timeSelect').value;
        let html = '<strong>'+kabupaten+'</strong><br/>';
        const k = Object.keys(forecastData).find(fk => normName(fk) === normName(kabupaten));
        if(k && forecastData[k] && forecastData[k][t]){
          const info = forecastData[k][t];
          html += 'Waktu: ' + t + '<br>';
          html += 'Cuaca: ' + info.cuaca + '<br>';
          html += 'Suhu: ' + info.suhu + ' Â°C<br>';
          html += 'Hum: ' + info.hum + '<br>';
        } else {
          html += 'Data prakiraan tidak tersedia.';
        }
        layer.bindPopup(html).openPopup();
      }
    });
  }

  function addGeojsonLayer(geojson, timeKey){
    if(geojsonLayer) map.removeLayer(geojsonLayer);
    geojsonLayer = L.geoJson(geojson, {
      style: f => styleFeature(f, timeKey),
      onEachFeature: onEachFeature
    }).addTo(map);
    map.fitBounds(geojsonLayer.getBounds(), {padding:[20,20]});
  }

  function updateChoropleth(timeKey){
    if(!geojsonLayer) return;
    geojsonLayer.eachLayer(layer=>{
      const f = layer.feature;
      layer.setStyle(styleFeature(f, timeKey));
    });
  }

  function drawLegend(){
    const legendDiv = document.getElementById('legend');
    legendDiv.innerHTML = '<strong>Legenda</strong><br/>';
    const order = ["Cerah","Cerah Berawan","Berawan","Hujan Ringan","Hujan Sedang","Hujan Lebat","Hujan Sangat Lebat","Ekstrem"];
    order.forEach(k=>{
      const col = categoryColors[k] || '#cccccc';
      const item = document.createElement('div');
      item.className = 'item';
      item.innerHTML = '<span class="colorbox" style="background:'+col+'"></span> ' + k;
      legendDiv.appendChild(item);
    });
  }
  </script>
</body>
</html>
