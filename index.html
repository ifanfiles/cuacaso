<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <title>Peta Prakiraan Hujan per Kabupaten</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    #map { height: 86vh; }
    .controls { padding:8px; background:#fff; box-shadow:0 1px 4px rgba(0,0,0,0.3); display:flex; gap:10px; align-items:center;}
    .legend { background:#fff; padding:8px; line-height:1.6; }
    .legend .item { display:flex; align-items:center; gap:8px; }
    .colorbox { width:18px; height:14px; display:inline-block; border:1px solid #444; }
    .timestamp-overlay {
      position:absolute;
      top:50px; left:10px;
      background:rgba(255,255,255,0.8);
      padding:6px 12px;
      border-radius:4px;
      font-size:18px;
      font-weight:bold;
      z-index:1000;
    }
  </style>
</head>
<body>
  <div class="controls">
    <label>Waktu: <select id="timeSelect"></select></label>
    <button id="playBtn">▶ Play</button>
    <button id="pauseBtn" disabled>⏸ Pause</button>
    <label>Kecepatan: 
      <select id="speedSelect">
        <option value="1000">1 detik</option>
        <option value="2000" selected>2 detik</option>
        <option value="5000">5 detik</option>
      </select>
    </label>
  </div>
  <div id="map"></div>
  <div id="legend" class="legend" style="position: absolute; right: 10px; bottom: 10px; z-index:1000;"></div>
  <div id="timestamp" class="timestamp-overlay">-</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  // --- Warna kategori cuaca ---
  const categoryColors = {
   
    "Hujan Ringan": "#7be57b",
    "Hujan Sedang": "#ffd84d",
    "Hujan Lebat": "#ff9a2e",
    "Hujan Sangat Lebat": "#ff4d4d",
    "Ekstrem": "#b84dff"
  };

  const GEOJSON_FILE = 'Batas_SO_kel.json';
  const FORECAST_FILE = 'prakiraan_kabupaten_full3jam.json';

  let map = L.map('map').setView([-7.9, 110.4], 9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OSM'
  }).addTo(map);

  let geojsonLayer;
  let forecastData = null;
  let timestamps = [];
  let playInterval = null;
  let currentIndex = 0;
  let playSpeed = 2000; // default 2 detik

  function normName(name){
    return (name||'').trim().toLowerCase();
  }

  // Load data
  Promise.all([
    fetch(FORECAST_FILE).then(r=>r.json()),
    fetch(GEOJSON_FILE).then(r=>r.json())
  ]).then(([forecast, geojson])=>{
    forecastData = forecast;

    const firstKey = Object.keys(forecastData)[0];
    timestamps = Object.keys(forecastData[firstKey]);
    const timeSelect = document.getElementById('timeSelect');
    timestamps.forEach((t,i)=>{
      const opt = document.createElement('option');
      opt.value = t;
      opt.textContent = t;
      timeSelect.appendChild(opt);
    });

    addGeojsonLayer(geojson, timestamps[0]);

    timeSelect.addEventListener('change', (e)=>{
      currentIndex = timestamps.indexOf(e.target.value);
      updateChoropleth(e.target.value);
    });

    document.getElementById('playBtn').addEventListener('click', startPlay);
    document.getElementById('pauseBtn').addEventListener('click', stopPlay);

    document.getElementById('speedSelect').addEventListener('change', (e)=>{
      playSpeed = parseInt(e.target.value);
      if(playInterval){ // restart interval dengan speed baru
        stopPlay();
        startPlay();
      }
    });

    drawLegend();
  }).catch(err=>{
    console.error(err);
    alert('Gagal memuat data. Pastikan file JSON & GeoJSON ada di folder yang sama.');
  });

  function styleFeature(feature, timeKey){
    const props = feature.properties || {};
    const kabupaten = props.WADMKC;
    let cuaca = null, suhu = null, hum = null;

    const k = Object.keys(forecastData).find(fk => normName(fk) === normName(kabupaten));
    if(k && forecastData[k] && forecastData[k][timeKey]){
      cuaca = forecastData[k][timeKey].cuaca;
      suhu = forecastData[k][timeKey].suhu;
      hum = forecastData[k][timeKey].hum;
    }

    const color = categoryColors[cuaca] || '#cccccc';
    return {
      color: '#444',
      weight: 0.6,
      fillColor: color,
      fillOpacity: 0.8
    };
  }

  function onEachFeature(feature, layer){
    layer.on({
      click: function(e){
        const props = feature.properties || {};
        const kabupaten = props.WADMKD;
        const t = document.getElementById('timeSelect').value;
        let html = '<strong>'+kabupaten+'</strong><br/>';
        const k = Object.keys(forecastData).find(fk => normName(fk) === normName(kabupaten));
        if(k && forecastData[k] && forecastData[k][t]){
          const info = forecastData[k][t];
          html += 'Waktu: ' + t + '<br>';
          html += 'Cuaca: ' + info.cuaca + '<br>';
          html += 'Suhu: ' + info.suhu + ' °C<br>';
          html += 'Hum: ' + info.hum + '<br>';
        } else {
          html += 'Data prakiraan tidak tersedia.';
        }
        layer.bindPopup(html).openPopup();
      }
    });
  }

  function addGeojsonLayer(geojson, timeKey){
    if(geojsonLayer) map.removeLayer(geojsonLayer);
    geojsonLayer = L.geoJson(geojson, {
      style: f => styleFeature(f, timeKey),
      onEachFeature: onEachFeature
    }).addTo(map);
    map.fitBounds(geojsonLayer.getBounds(), {padding:[20,20]});
    updateTimestamp(timeKey);
  }

  function updateChoropleth(timeKey){
    if(!geojsonLayer) return;
    geojsonLayer.eachLayer(layer=>{
      layer.setStyle(styleFeature(layer.feature, timeKey));
    });
    document.getElementById('timeSelect').value = timeKey;
    updateTimestamp(timeKey);
  }

  function updateTimestamp(t){
    document.getElementById('timestamp').textContent = t;
  }

  function drawLegend(){
    const legendDiv = document.getElementById('legend');
    legendDiv.innerHTML = '<strong>Legenda</strong><br/>';
    const order = ["Cerah","Cerah Berawan","Berawan","Hujan Ringan","Hujan Sedang","Hujan Lebat","Hujan Sangat Lebat","Ekstrem"];
    order.forEach(k=>{
      const col = categoryColors[k] || '#cccccc';
      const item = document.createElement('div');
      item.className = 'item';
      item.innerHTML = '<span class="colorbox" style="background:'+col+'"></span> ' + k;
      legendDiv.appendChild(item);
    });
  }

  function startPlay(){
    if(playInterval) return;
    document.getElementById('playBtn').disabled = true;
    document.getElementById('pauseBtn').disabled = false;

    playInterval = setInterval(()=>{
      currentIndex = (currentIndex + 1) % timestamps.length;
      updateChoropleth(timestamps[currentIndex]);
    }, playSpeed);
  }

  function stopPlay(){
    clearInterval(playInterval);
    playInterval = null;
    document.getElementById('playBtn').disabled = false;
    document.getElementById('pauseBtn').disabled = true;
  }
  </script>
</body>
</html>
